<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡æ¿ä¸æ–‡æ¡£ç”Ÿæˆå·¥å…· - ç¾åŒ–ç‰ˆ</title>
    <style>
        :root {
            --pink-primary: #E91E63;
            --pink-light: #FFD0E0;
            --pink-lighter: #FFF0F5;
            --pink-border: #FFB6C1;
            --gold-header: #EAAA00; /* Existing header color */
            --text-color: #333;
            --text-light: #555;
            --text-placeholder: #999;
            --bg-color: #fdf6f8; /* Even lighter pinkish background */
            --bg-alt: #ffffff; /* White for contrast */
            --border-color: #eee; /* Lighter general border */
            --border-focus: var(--pink-primary);
            --shadow-color: rgba(0, 0, 0, 0.08);
            --icon-color: var(--pink-primary);
            --delete-color: #f44336;
            --add-color: #4CAF50;

            --font-main: "Microsoft YaHei", "å¾®è½¯é›…é»‘", Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        }

        body {
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            font-size: 14px; /* Base font size */
        }

        /* Header */
        .header {
            background-color: var(--gold-header);
            color: white;
            padding: 12px 25px;
            text-align: center;
            box-shadow: 0 2px 5px var(--shadow-color);
            flex-shrink: 0;
            z-index: 10; /* Ensure header is on top */
        }
         .header h1 {
             margin: 0;
             font-size: 1.6em;
             font-weight: 600;
         }

        /* Main Container */
        .main-container {
            width: 95%; /* Use more screen width */
            max-width: 1600px; /* Max width for very large screens */
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            background-color: var(--bg-alt);
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-color);
            padding: 20px;
            gap: 20px;
            overflow: hidden; /* Prevent content spilling */
        }

        /* Section Headers */
        .section-header {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--pink-primary);
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--pink-light);
        }

        /* Top Controls Area */
        .top-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .top-controls label {
            margin-right: 5px;
            font-weight: 600;
            color: var(--text-light);
        }
        .top-controls select, .top-controls button {
            padding: 8px 14px;
            border: 1px solid var(--pink-border);
            border-radius: 5px;
            background-color: var(--bg-alt);
            color: var(--pink-primary);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 0.95em;
        }
        .top-controls select {
             min-width: 150px;
             appearance: none; /* Custom dropdown arrow potentially */
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23E91E63'%3E%3Cpath fill-rule='evenodd' d='M8 11.293l-4.646-4.647a.5.5 0 0 1 .708-.708L8 9.879l4.939-4.94a.5.5 0 0 1 .707.708L8 11.293z'/%3E%3C/svg%3E"); /* Basic SVG arrow */
             background-repeat: no-repeat;
             background-position: right 10px center;
             background-size: 16px;
             padding-right: 30px; /* Space for arrow */
        }
        .top-controls button:hover {
            background-color: var(--pink-lighter);
            border-color: var(--pink-primary);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .top-controls button:active {
             background-color: var(--pink-light);
        }
         .top-controls button .icon { /* Style for icon placeholders */
             margin-right: 6px;
             font-weight: bold;
         }
        #template-file-input, #import-excel-input { display: none; }

        /* Middle Area Layout */
        .middle-area {
            display: flex;
            gap: 20px;
            flex-grow: 1;
            overflow: hidden; /* Important for contained scrolling */
        }
        .left-pane, .right-pane {
            flex: 1; /* Start with equal width, adjust flex values if needed */
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            background-color: var(--bg-color);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            overflow: hidden; /* Panes manage their own overflow */
        }
         /* Adjust flex-basis or flex-grow if specific ratios are desired */
         .left-pane { flex-basis: 45%; }
         .right-pane { flex-basis: 55%; }

        /* Field Management Controls */
        .field-management-controls {
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 5px;
        }
        .field-management-controls .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .field-management-controls label {
            width: 75px;
            text-align: right;
            font-size: 0.9em;
            color: var(--text-light);
        }
        .field-management-controls input[type="text"] {
            flex-grow: 1;
            padding: 8px 10px;
            border: 1px solid var(--pink-border);
            border-radius: 4px;
            font-size: 0.95em;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
         .field-management-controls input[type="text"]:focus {
              outline: none;
              border-color: var(--border-focus);
              box-shadow: 0 0 0 2px var(--pink-lighter);
         }
        .field-management-controls button {
            padding: 7px 12px;
            white-space: nowrap;
            font-size: 0.9em;
        }

        /* Field List Display */
        .field-list-display-area {
            flex-grow: 1;
            overflow-y: auto; /* Scroll this area */
            padding-right: 8px; /* Scrollbar space */
        }
        .object-field-list, .list-field-definitions {
             margin-bottom: 15px;
        }
        .field-list-header { /* Header within scrollable area */
             font-size: 1.05em;
             font-weight: 600;
             color: var(--pink-primary);
             margin: 0 0 10px 0;
             padding-bottom: 5px;
             border-bottom: 1px solid var(--pink-light);
        }
         .field-list-header small {
              font-weight: normal;
              font-size: 0.85em;
              color: var(--text-light);
         }

        /* Object Field List Items */
        .field-list-item {
             display: flex;
             align-items: center;
             padding: 6px 4px;
             font-size: 0.95em;
             gap: 15px; /* More space */
             border-bottom: 1px solid var(--border-color);
             cursor: pointer;
             transition: background-color 0.15s;
        }
        .field-list-item:last-child { border-bottom: none; }
        .field-list-item:hover { background-color: var(--pink-lighter); }

        .field-list-item .field-name { flex: 1; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .field-list-item .field-placeholder { flex: 2; color: var(--text-light); font-family: monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9em;}
        .field-list-item .field-delete-btn {
            background: none; border: none; color: var(--delete-color); cursor: pointer;
            font-weight: bold; padding: 2px 5px; font-size: 1.2em; line-height: 1;
            margin-left: auto; /* Push delete button to the right */
            opacity: 0.7;
             transition: opacity 0.2s;
        }
        .field-list-item:hover .field-delete-btn { opacity: 1; }
        .field-list-item .field-delete-btn:hover { color: darkred; }

        /* List Definition Area */
        .list-definition-block {
            margin-bottom: 15px;
            padding: 10px;
            background-color: var(--bg-alt);
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }
        .list-object-row {
             display: flex;
             align-items: center;
             gap: 8px;
             padding: 5px 0;
             position: relative; /* For potential absolute positioning if needed */
        }
         .list-object-row:not(:last-child) {
              border-bottom: 1px dotted var(--pink-border);
         }

        .list-object-row .list-name-label {
            flex: 0 0 100px; /* Fixed width for list name */
            font-weight: 600;
            color: var(--pink-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 0; /* Hide by default, show only for first */
            align-self: flex-start;
            padding-top: 8px; /* Align with input */
            transition: opacity 0.2s;
        }
        .list-object-row.is-first-row .list-name-label {
             opacity: 1; /* Show for first row */
        }

        .list-object-row input[type="text"] { /* List Object Name Input */
             flex: 1;
             padding: 7px 9px;
             font-size: 0.9em;
             border: 1px solid var(--pink-border);
             border-radius: 4px;
        }
         .list-object-row input[type="text"]:focus {
              outline: none;
              border-color: var(--border-focus);
              box-shadow: 0 0 0 2px var(--pink-lighter);
         }
        .list-object-row .list-action-btn {
            background: none; border: none; border-radius: 50%;
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-weight: bold; line-height: 1; padding: 0; font-size: 1.2em;
            transition: background-color 0.2s;
        }
        .list-object-row .add-list-object-btn { color: var(--add-color); }
        .list-object-row .delete-list-object-btn { color: var(--delete-color); }
        .list-object-row .add-list-object-btn:hover { background-color: #e8f5e9; }
        .list-object-row .delete-list-object-btn:hover { background-color: #ffebee; }

        /* Data Filling Area */
        .data-filling-area {
            flex-grow: 1;
            overflow-y: auto;
             padding-right: 8px; /* Scrollbar space */
        }
        .object-filling-list, .list-filling-tables {
            margin-bottom: 15px;
        }

        /* Object Filling Items */
        .object-filling-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        .object-filling-item label {
            width: 140px; /* Adjust as needed */
            text-align: right;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--text-light);
            white-space: nowrap;
        }
        .object-filling-item input[type="text"] {
            flex-grow: 1;
            padding: 8px 10px;
            border: 1px solid var(--pink-border);
            border-radius: 4px;
            font-size: 0.95em;
        }
         .object-filling-item input[type="text"]:focus {
              outline: none;
              border-color: var(--border-focus);
              box-shadow: 0 0 0 2px var(--pink-lighter);
         }

        /* List Filling Table */
        .list-data-table-block {
             margin-bottom: 20px;
             padding: 15px;
             background-color: var(--bg-alt);
             border: 1px solid var(--border-color);
             border-radius: 5px;
        }
        .list-data-table-block .list-data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .list-data-table-block h5 {
            margin: 0;
            font-size: 1.05em;
            color: var(--pink-primary);
        }
        .list-data-table-block .add-list-data-row-btn {
             padding: 5px 10px;
             font-size: 0.9em;
        }
        .list-data-table {
            width: 100%;
            border-collapse: separate; /* Use separate for rounded corners */
            border-spacing: 0;
            font-size: 0.9em;
            border: 1px solid var(--pink-border);
            border-radius: 4px;
            overflow: hidden; /* Clip content to rounded border */
        }
        .list-data-table th, .list-data-table td {
            border-bottom: 1px solid var(--pink-border);
             border-right: 1px solid var(--pink-border);
            padding: 8px 10px;
            text-align: left;
            vertical-align: middle;
        }
         .list-data-table th:last-child, .list-data-table td:last-child {
             border-right: none;
         }
         .list-data-table tr:last-child td {
              border-bottom: none;
         }

        .list-data-table th {
            background-color: var(--pink-lighter);
            color: var(--pink-primary);
            font-weight: 600;
            white-space: nowrap;
        }
        .list-data-table td input[type="text"] {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid transparent; /* Transparent border */
            border-radius: 3px;
            box-sizing: border-box;
            background-color: transparent;
             transition: border-color 0.2s, background-color 0.2s;
        }
        .list-data-table td input[type="text"]:focus {
             outline: none;
             border-color: var(--border-focus);
             background-color: white;
             box-shadow: 0 0 0 1px var(--border-focus);
        }

        /* Bottom Area Layout */
        .bottom-area {
            display: flex;
            gap: 20px;
            flex-grow: 1; /* Let bottom grow more if needed */
            min-height: 250px; /* Adjust min height */
            overflow: hidden;
        }
        .editor-pane, .preview-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-alt);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            overflow: hidden;
        }
        .editor-pane .section-header, .preview-pane .section-header {
             flex-shrink: 0;
        }
         .editor-pane .header-note {
              font-weight: normal;
              font-size: 0.85em;
              color: var(--text-light);
              margin-left: 8px;
         }

        .editor-content, .preview-content {
            flex-grow: 1;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: auto; /* Scroll content */
            padding: 12px;
            line-height: 1.6;
            background-color: white;
             font-size: 0.95em; /* Slightly larger editor font */
        }
        .editor-content[contenteditable="true"] {
             outline: none;
        }
         .editor-content[contenteditable="true"]:focus-within { /* Focus style on container */
             border-color: var(--border-focus);
             box-shadow: 0 0 0 2px var(--pink-lighter);
         }
         .preview-content {
              background-color: #f9f9f9; /* Slightly off-white preview */
         }

        /* Editor Placeholder Style */
        .editor-placeholder {
            background-color: var(--placeholder-bg);
            border: 1px dashed var(--placeholder-border);
            padding: 1px 4px;
            border-radius: 3px;
            font-family: monospace;
            cursor: default;
            color: var(--pink-primary);
            display: inline-block; /* Ensure background covers text */
        }
        /* Excel Placeholders */
        .excel-placeholder-view {
             display: flex;
             align-items: center;
             justify-content: center;
             text-align: center;
             color: var(--text-placeholder);
             font-style: italic;
             height: 100%;
        }

        /* Bottom Button Bar */
        .bottom-buttons {
            display: flex;
            justify-content: space-between;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            background-color: var(--bg-alt); /* Match main background */
            margin: 0 -20px -15px -20px; /* Extend to container edges */
            padding: 15px 20px;
            border-radius: 0 0 8px 8px; /* Match container rounding */
        }
        .button-group { display: flex; gap: 12px; }

        .bottom-buttons button {
            padding: 9px 20px;
            border: 1px solid var(--pink-border);
            border-radius: 5px;
            background-color: var(--bg-alt);
            color: var(--pink-primary);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.2s ease-in-out;
        }
        .bottom-buttons button .icon { margin-right: 6px; font-weight: bold;}
        .bottom-buttons button:hover {
            background-color: var(--pink-lighter);
            border-color: var(--pink-primary);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
         .bottom-buttons button:active {
              transform: translateY(0);
              box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
              background-color: var(--pink-light);
         }

        .bottom-buttons .primary-action { /* Generate Document */
            background-color: var(--pink-primary);
            color: white;
            border-color: var(--pink-primary);
        }
        .bottom-buttons .primary-action:hover {
            background-color: var(--hover-color);
            border-color: var(--hover-color);
        }
         .bottom-buttons .primary-action:active {
              background-color: #b8154d; /* Slightly darker active */
         }

        /* Scrollbar styling (optional, WebKit specific) */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px;}
        ::-webkit-scrollbar-thumb { background: var(--pink-border); border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: var(--pink-light); }

    </style>
</head>
<body>
    <div class="header">
        <h1>æ¨¡æ¿ä¸æ–‡æ¡£ç”Ÿæˆå·¥å…·</h1>
    </div>

    <div class="main-container">

        <!-- 1. Top Controls -->
        <div class="top-controls">
            <label for="template-type-select">æ¨¡æ¿ç±»å‹:</label>
            <select id="template-type-select" onchange="handleTemplateTypeChange()">
                <option value="word">Word (.docx)</option>
                <option value="excel">Excel (.xlsx)</option>
            </select>
            <button id="select-template-btn" onclick="selectTemplateFile()">
                <span class="icon">ğŸ“</span>é€‰æ‹©æ¨¡æ¿
            </button>
            <input type="file" id="template-file-input" accept=".docx,.xlsx" onchange="handleTemplateFileSelected(event)">

            <!-- Spacer -->
            <div style="flex-grow: 1;"></div>

            <button id="export-fields-btn" onclick="exportFieldsToExcel()">
                <span class="icon">â†“</span>å­—æ®µå¯¼å‡º
            </button>
            <button id="import-data-btn" onclick="importDataFromExcel()">
                <span class="icon">â†‘</span>Excelæ•°æ®å¯¼å…¥
            </button>
            <input type="file" id="import-excel-input" accept=".xlsx,.xls" onchange="handleExcelDataImport(event)">
        </div>

        <!-- 2. Middle Area (Split) -->
        <div class="middle-area">
            <!-- 2a. Left Pane -->
            <div class="left-pane">
                <!-- Field Management Controls -->
                <div class="field-management-controls">
                    <div class="input-row">
                        <label for="object-field-input">å¯¹è±¡å­—æ®µ:</label>
                        <input type="text" id="object-field-input" placeholder="ä¾‹å¦‚: customerName">
                        <button onclick="addObjectField()"><span class="icon">+</span>æ·»åŠ </button>
                    </div>
                    <div class="input-row">
                        <label for="list-name-input">åˆ—è¡¨åç§°:</label>
                        <input type="text" id="list-name-input" placeholder="ä¾‹å¦‚: products">
                        <button onclick="addListName()"><span class="icon">+</span>æ·»åŠ </button>
                    </div>
                </div>

                <!-- Field List Display Scrollable Area -->
                <div class="field-list-display-area">
                    <!-- Object Fields -->
                    <div class="object-field-list">
                        <h4 class="field-list-header">å¯¹è±¡å­—æ®µåˆ—è¡¨ <small>(åŒå‡»æ’å…¥)</small></h4>
                        <div id="object-field-list-container">
                            <!-- JS adds .field-list-item here -->
                            <div style="text-align: center; color: var(--text-placeholder); padding: 10px 0;">æš‚æ— å¯¹è±¡å­—æ®µ</div>
                        </div>
                    </div>

                    <!-- List Definitions -->
                    <div class="list-field-definitions">
                        <h4 class="field-list-header">åˆ—è¡¨åç§°ä¸å¯¹è±¡ <small>(åŒå‡»åˆ—è¡¨å¯¹è±¡æ’å…¥)</small></h4>
                        <div id="list-field-list-container">
                             <!-- JS adds .list-definition-block here -->
                             <div style="text-align: center; color: var(--text-placeholder); padding: 10px 0;">æš‚æ— åˆ—è¡¨</div>
                        </div>
                    </div>
                </div>
            </div><!-- End Left Pane -->

            <!-- 2b. Right Pane -->
            <div class="right-pane">
                 <!-- Data Filling Scrollable Area -->
                <div class="data-filling-area">
                     <!-- Object Field Filling -->
                    <div class="object-filling-list">
                         <h4 class="section-header">å¯¹è±¡å­—æ®µå¡«å……</h4>
                         <div id="object-filling-container">
                             <!-- JS adds .object-filling-item here -->
                             <div style="text-align: center; color: var(--text-placeholder); padding: 10px 0;">æš‚æ— å¯¹è±¡å­—æ®µ</div>
                         </div>
                    </div>

                     <!-- List Data Filling -->
                    <div class="list-filling-tables">
                         <h4 class="section-header">åˆ—è¡¨æ•°æ®å¡«å……</h4>
                         <div id="list-filling-container">
                              <!-- JS adds .list-data-table-block here -->
                              <div style="text-align: center; color: var(--text-placeholder); padding: 10px 0;">æš‚æ— åˆ—è¡¨</div>
                         </div>
                    </div>
                </div>
            </div><!-- End Right Pane -->
        </div><!-- End Middle Area -->

        <!-- 3. Bottom Area (Split) -->
        <div class="bottom-area">
            <!-- 3a. Editor Pane -->
            <div class="editor-pane">
                <h4 class="section-header">
                    æ¨¡æ¿ç¼–è¾‘åŒºåŸŸ
                    <span id="loaded-template-name" class="header-note"></span>
                </h4>
                <!-- Stack for Word/Excel Editor Views -->
                <div style="flex-grow: 1; position: relative;"> <!-- Container for stack -->
                    <div id="template-editor-content" class="editor-content" contenteditable="true" oninput="handleEditorInput()">
                        <p style="color: var(--text-placeholder);">è¯·å…ˆé€šè¿‡â€œé€‰æ‹©æ¨¡æ¿â€æŒ‰é’®åŠ è½½æ¨¡æ¿ï¼Œæˆ–åœ¨æ­¤å¤„å¼€å§‹ç¼–è¾‘ã€‚</p>
                    </div>
                    <div id="excel-editor-placeholder" class="excel-placeholder-view editor-content" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                        Excelæ¨¡æ¿ç¼–è¾‘åŒº (åŠŸèƒ½éœ€ç‰¹å®šåº“æ”¯æŒ)
                    </div>
                </div>
            </div><!-- End Editor Pane -->

            <!-- 3b. Preview Pane -->
            <div class="preview-pane">
                <h4 class="section-header">å®æ—¶é¢„è§ˆåŒºåŸŸ</h4>
                 <!-- Stack for Word/Excel Preview Views -->
                 <div style="flex-grow: 1; position: relative;"> <!-- Container for stack -->
                    <div id="preview-content" class="preview-content">
                       <p style="color: var(--text-placeholder);">é¢„è§ˆå°†æ ¹æ®æ¨¡æ¿å’Œå¡«å……æ•°æ®å®æ—¶æ›´æ–°ã€‚</p>
                    </div>
                    <div id="excel-preview-placeholder" class="excel-placeholder-view preview-content" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                       Excelé¢„è§ˆåŒº (åŠŸèƒ½éœ€ç‰¹å®šåº“æ”¯æŒ)
                    </div>
                </div>
            </div><!-- End Preview Pane -->
        </div><!-- End Bottom Area -->

        <!-- 4. Bottom Buttons -->
        <div class="bottom-buttons">
            <div class="button-group">
                 <button id="save-template-btn" onclick="saveTemplate()"><span class="icon">ğŸ’¾</span>ä¿å­˜æ¨¡æ¿</button>
                 <button id="generate-template-btn" onclick="generateNewTemplate()"><span class="icon">âœ¨</span>ç”Ÿæˆæ¨¡æ¿(å¦å­˜)</button>
            </div>
             <div class="button-group">
                 <button id="generate-document-btn" class="primary-action" onclick="generateDocument()"><span class="icon">ğŸ“„</span>ç”Ÿæˆæ–‡æ¡£</button>
             </div>
        </div>

    </div><!-- End Main Container -->

    <script>
        // --- PASTE JavaScript from previous 'doc_gemini.html' HERE ---
        // (Make sure IDs used in JS match the IDs in this HTML)

        // --- Global State (Example Placeholders) ---
        let currentTemplateType = 'word'; // 'word' or 'excel'
        let currentTemplateContent = ''; // Store raw template content
        let loadedTemplatePath = null; // Store the path/handle of the loaded file for overwrite
        let objectFields = []; // Array of { name: 'fieldName', placeholder: '{{fieldName}}' }
        let listFields = {}; // Object like: { listName: ['objectName1', 'objectName2'] }
        let objectData = {}; // { fieldName: 'value' }
        let listData = {}; // { listName: [ {objectName1: 'val', objectName2: 'val'}, ...rows ] }

        // --- DOM Elements (Cache frequently used ones) ---
        const templateTypeSelect = document.getElementById('template-type-select');
        const templateFileInput = document.getElementById('template-file-input');
        const importExcelInput = document.getElementById('import-excel-input');
        const objectFieldInputEl = document.getElementById('object-field-input');
        const listNameInputEl = document.getElementById('list-name-input');
        const objectFieldListContainer = document.getElementById('object-field-list-container');
        const listFieldListContainer = document.getElementById('list-field-list-container');
        const objectFillingContainer = document.getElementById('object-filling-container');
        const listFillingContainer = document.getElementById('list-filling-container');
        const templateEditorContent = document.getElementById('template-editor-content');
        const previewContent = document.getElementById('preview-content');
        const loadedTemplateNameEl = document.getElementById('loaded-template-name');
        const excelEditorPlaceholder = document.getElementById('excel-editor-placeholder');
        const excelPreviewPlaceholder = document.getElementById('excel-preview-placeholder');


        // --- Event Handlers & Functions ---

        function handleTemplateTypeChange() {
            currentTemplateType = templateTypeSelect.value;
            console.log("Template type changed to:", currentTemplateType);
             // Toggle Visibility of Editor/Preview areas
             const isExcel = currentTemplateType === 'excel';
             templateEditorContent.style.display = isExcel ? 'none' : 'block';
             excelEditorPlaceholder.style.display = isExcel ? 'flex' : 'none'; // Use flex for centering
             previewContent.style.display = isExcel ? 'none' : 'block';
             excelPreviewPlaceholder.style.display = isExcel ? 'flex' : 'none';

             if(isExcel) {
                  alert("Excel æ¨¡æ¿ç¼–è¾‘å’Œé¢„è§ˆéœ€è¦ç‰¹å®šåº“æ”¯æŒï¼Œå½“å‰ç•Œé¢ä¸ºå ä½ç¬¦ã€‚");
             }

             // Reset content when type changes
             templateEditorContent.innerHTML = '<p style="color: var(--text-placeholder);">æ¨¡æ¿ç±»å‹å·²åˆ‡æ¢ï¼Œè¯·é‡æ–°åŠ è½½æˆ–ç¼–è¾‘ã€‚</p>';
             previewContent.innerHTML = '<p style="color: var(--text-placeholder);">é¢„è§ˆå°†æ ¹æ®æ¨¡æ¿å’Œå¡«å……çš„æ•°æ®å®æ—¶æ›´æ–°ã€‚</p>';
             loadedTemplateNameEl.textContent = ''; // Clear loaded template name
             loadedTemplatePath = null;
        }

        function selectTemplateFile() {
            templateFileInput.accept = currentTemplateType === 'word' ? '.docx' : '.xlsx';
            templateFileInput.click();
        }

        function handleTemplateFileSelected(event) {
            const file = event.target.files[0];
            if (!file) return;
            console.log("Template file selected:", file.name);
            loadedTemplatePath = file;
            loadedTemplateNameEl.textContent = `- ${file.name}`;

            alert(`æ¨¡æ¿æ–‡ä»¶ "${file.name}" å·²é€‰æ‹©ã€‚\nå®é™…çš„æ–‡ä»¶å†…å®¹åŠ è½½å’Œè§£æéœ€è¦ä¸“é—¨çš„åº“ã€‚\nç¼–è¾‘å™¨å°†æ˜¾ç¤ºæ¨¡æ‹Ÿå†…å®¹ã€‚`);

            // Simulate loading content into editor
            if (currentTemplateType === 'word') {
                templateEditorContent.innerHTML = `<h1>æ¨¡æ‹ŸåŠ è½½: ${file.name}</h1><p>è¿™æ˜¯ä» <b>${file.name}</b> åŠ è½½çš„æ¨¡æ‹Ÿå†…å®¹ã€‚</p><p>åŒ…å«å ä½ç¬¦: <span class="editor-placeholder">{{exampleField}}</span> å’Œ <span class="editor-placeholder">{{anotherField}}</span></p>`;
                 currentTemplateContent = templateEditorContent.innerHTML;
            } else {
                 excelEditorPlaceholder.innerHTML = `Excel æ¨¡æ¿ "${file.name}" å·²åŠ è½½ (æ¨¡æ‹Ÿ)ã€‚`;
                 currentTemplateContent = `Excel: ${file.name}`;
            }

            event.target.value = null;
            updatePreview();
        }

        function exportFieldsToExcel() {
             console.log("Exporting fields to Excel...");
             alert("å­—æ®µå¯¼å‡ºåŠŸèƒ½éœ€è¦å®ç°ã€‚\nå°†æ”¶é›†å½“å‰å®šä¹‰çš„å¯¹è±¡å­—æ®µå’Œåˆ—è¡¨å­—æ®µï¼Œå¹¶ç”ŸæˆåŒ¹é…æ•°æ®å¡«å……åŒºåŸŸç»“æ„çš„Excelæ¨¡æ¿ã€‚");
             // --- Needs SheetJS etc. ---
        }

        function importDataFromExcel() {
            importExcelInput.click();
        }

        function handleExcelDataImport(event) {
             const file = event.target.files[0];
             if (!file) return;
             console.log("Importing data from Excel:", file.name);
             alert(`Excel æ•°æ®æ–‡ä»¶ "${file.name}" å·²é€‰æ‹©ã€‚\nå®é™…çš„æ•°æ®è§£æå’Œå¡«å……éœ€è¦åº“æ”¯æŒã€‚`);
             event.target.value = null;
             // --- Needs SheetJS etc. ---
             // --- Simulate data filling & update preview ---
             // objectData['exampleField'] = 'æ¥è‡ªExcelçš„å€¼';
             // renderObjectFillingList(); // Re-render to show imported data
             // updatePreview();
        }

        function addObjectField() {
            const fieldName = objectFieldInputEl.value.trim();
            if (!fieldName || objectFields.some(f => f.name === fieldName)) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ã€å”¯ä¸€çš„å¯¹è±¡å­—æ®µåç§°ã€‚"); return;
            }
             if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(fieldName)) { // Start with letter or _, then alphanumeric/underscore
                 alert("å­—æ®µåç§°å¿…é¡»ä»¥å­—æ¯æˆ–ä¸‹åˆ’çº¿å¼€å¤´ï¼Œä¸”åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ã€‚"); return;
             }

            const placeholder = `{{${fieldName}}}`;
            objectFields.push({ name: fieldName, placeholder: placeholder });
            objectFieldInputEl.value = '';

            renderObjectFieldList();
            renderObjectFillingList();
            updatePreview();
            console.log("Added object field:", fieldName);
        }

         function removeObjectField(buttonElement, fieldName) {
            objectFields = objectFields.filter(f => f.name !== fieldName);
            delete objectData[fieldName];

            renderObjectFieldList();
            renderObjectFillingList();
            updatePreview();
            console.log("Removed object field:", fieldName);
         }

        function addListName() {
            const listName = listNameInputEl.value.trim();
             if (!listName || listFields.hasOwnProperty(listName)) {
                 alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ã€å”¯ä¸€çš„åˆ—è¡¨åç§°ã€‚"); return;
             }
            if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(listName)) {
                 alert("åˆ—è¡¨åç§°å¿…é¡»ä»¥å­—æ¯æˆ–ä¸‹åˆ’çº¿å¼€å¤´ï¼Œä¸”åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ã€‚"); return;
             }

            listFields[listName] = []; // Initialize with empty object list
            listData[listName] = [];
            listNameInputEl.value = '';

            renderListFieldArea();
            renderListFillingTables();
            updatePreview();
            console.log("Added list name:", listName);
        }

        // --- Rendering Functions ---

        function renderObjectFieldList() {
            objectFieldListContainer.innerHTML = ''; // Clear previous items
            if (objectFields.length === 0) {
                objectFieldListContainer.innerHTML = '<div style="text-align: center; color: var(--text-placeholder); padding: 10px 0;">æš‚æ— å¯¹è±¡å­—æ®µ</div>';
                return;
            }
            objectFields.forEach(field => {
                const item = document.createElement('div');
                item.className = 'field-list-item';
                item.ondblclick = () => insertPlaceholder(field.name, true); // Pass true for object field
                item.innerHTML = `
                    <span class="field-name" title="${field.name}">${field.name}</span>
                    <span class="field-placeholder" title="${field.placeholder}">${field.placeholder}</span>
                    <button class="field-delete-btn" onclick="removeObjectField(this, '${field.name}')" title="åˆ é™¤å­—æ®µ">âœ•</button>
                `;
                objectFieldListContainer.appendChild(item);
            });
        }

        function renderListFieldArea() {
            listFieldListContainer.innerHTML = '';
             if (Object.keys(listFields).length === 0) {
                listFieldListContainer.innerHTML = '<div style="text-align: center; color: var(--text-placeholder); padding: 10px 0;">æš‚æ— åˆ—è¡¨</div>';
                 return;
            }
            for (const listName in listFields) {
                const listContainer = document.createElement('div');
                listContainer.className = 'list-definition-block';
                listContainer.dataset.listName = listName;

                const listObjects = listFields[listName];
                if (listObjects.length === 0) {
                     listContainer.innerHTML += createListObjectRowHTML(listName, '', 0, true);
                } else {
                     listObjects.forEach((objName, index) => {
                         listContainer.innerHTML += createListObjectRowHTML(listName, objName, index, index === 0);
                     });
                }
                 listFieldListContainer.appendChild(listContainer);
            }
        }

        function createListObjectRowHTML(listName, objectName, index, isFirstRow) {
             const rowClass = isFirstRow ? 'list-object-row is-first-row' : 'list-object-row';
             // Double click on input to insert placeholder {{listName.objectName}}
             const ondblclickAttr = objectName ? `ondblclick="insertListObjectPlaceholder('${listName}', '${objectName}')"` : '';

             return `
                <div class="${rowClass}" data-list-name="${listName}" data-index="${index}">
                    <span class="list-name-label">${listName}</span>
                    <input type="text" placeholder="åˆ—è¡¨å†…å¯¹è±¡å, e.g., name" value="${objectName || ''}"
                           onchange="updateListObjectName('${listName}', ${index}, this.value)" ${ondblclickAttr} title="è¾“å…¥å¯¹è±¡å (åŒå‡»æ’å…¥å ä½ç¬¦)">
                    <button class="add-list-object-btn list-action-btn" onclick="addListObjectRow(this)" title="æ·»åŠ ä¸‹æ–¹å¯¹è±¡è¡Œ">+</button>
                    <button class="delete-list-object-btn list-action-btn" onclick="removeListObjectRow(this, '${listName}', ${index})" title="åˆ é™¤æ­¤å¯¹è±¡è¡Œ">âœ•</button>
                </div>
             `;
        }

        function renderObjectFillingList() {
             objectFillingContainer.innerHTML = '';
             if (objectFields.length === 0) {
                 objectFillingContainer.innerHTML = '<div style="text-align: center; color: var(--text-placeholder); padding: 10px 0;">æš‚æ— å¯¹è±¡å­—æ®µ</div>';
                 return;
             }
             objectFields.forEach(field => {
                 const item = document.createElement('div');
                 item.className = 'object-filling-item';
                 const dataId = `data-fill-${field.name}`;
                 item.innerHTML = `
                     <label for="${dataId}" title="${field.name}">${field.name}:</label>
                     <input type="text" id="${dataId}" value="${objectData[field.name] || ''}" oninput="updateObjectData('${field.name}', this.value); updatePreview();">
                 `;
                 objectFillingContainer.appendChild(item);
             });
        }

        function renderListFillingTables() {
            listFillingContainer.innerHTML = '';
             if (Object.keys(listFields).length === 0) {
                listFillingContainer.innerHTML = '<div style="text-align: center; color: var(--text-placeholder); padding: 10px 0;">æš‚æ— åˆ—è¡¨</div>';
                 return;
            }
            for (const listName in listFields) {
                 const listObjects = listFields[listName].filter(name => name.trim() !== ''); // Filter out empty object names
                 if (listObjects.length === 0) {
                    // Optionally show a message if a list is defined but has no object names yet
                    const emptyListMsg = document.createElement('div');
                    emptyListMsg.className = 'list-data-table-block';
                    emptyListMsg.innerHTML = `<h5>åˆ—è¡¨: ${listName}</h5><p style="color: var(--text-placeholder); font-size: 0.9em;">è¯·å…ˆåœ¨å·¦ä¾§ä¸ºåˆ—è¡¨ "${listName}" æ·»åŠ è‡³å°‘ä¸€ä¸ªå¯¹è±¡åç§°ã€‚</p>`;
                    listFillingContainer.appendChild(emptyListMsg);
                    continue;
                 };

                 const tableContainer = document.createElement('div');
                 tableContainer.className = 'list-data-table-block';
                 tableContainer.dataset.listName = listName;

                 let tableHTML = `<div class="list-data-header">
                                    <h5>åˆ—è¡¨: ${listName}</h5>
                                    <button class="add-list-data-row-btn action-button" onclick="addListDataRow('${listName}')" title="æ·»åŠ ä¸€è¡Œæ•°æ®">+ æ·»åŠ è¡Œ</button>
                                  </div>
                                 <table class="list-data-table">
                                    <thead><tr>`;
                 listObjects.forEach(objName => {
                     tableHTML += `<th title="${objName}">${objName}</th>`;
                 });
                 tableHTML += `</tr></thead><tbody>`;

                 const currentListData = listData[listName] || [];
                 if (currentListData.length === 0) {
                     // Add one empty row if no data
                     tableHTML += createListDataRowHTML(listName, listObjects, 0);
                     listData[listName] = [{}]; // Ensure data structure
                 } else {
                     currentListData.forEach((row, rowIndex) => {
                         tableHTML += createListDataRowHTML(listName, listObjects, rowIndex, row);
                     });
                 }
                 tableHTML += `</tbody></table>`;
                 tableContainer.innerHTML = tableHTML;
                 listFillingContainer.appendChild(tableContainer);
             }
        }

        function createListDataRowHTML(listName, listObjects, rowIndex, rowData = {}) {
             let rowHTML = '<tr>';
             listObjects.forEach(objName => {
                 const value = rowData[objName] || '';
                 rowHTML += `<td><input type="text" data-list="${listName}" data-row="${rowIndex}" data-col="${objName}" value="${value}" oninput="updateListData('${listName}', ${rowIndex}, '${objName}', this.value); updatePreview();"></td>`;
             });
             rowHTML += '</tr>';
             return rowHTML;
        }

        // --- Data Update Functions ---
        function updateObjectData(fieldName, value) {
            objectData[fieldName] = value;
        }

        function updateListData(listName, rowIndex, colName, value) {
            if (!listData[listName]) listData[listName] = [];
            while (listData[listName].length <= rowIndex) { listData[listName].push({}); }
            listData[listName][rowIndex][colName] = value;
        }

        function updateListObjectName(listName, index, newName) {
            newName = newName.trim(); // Trim whitespace
            const currentObjects = listFields[listName];
            const oldName = currentObjects[index];

            // Validate: Allow empty only if it's the only row being cleared
            if (newName === '' && currentObjects.length > 1 && index === currentObjects.length - 1) {
                // Allow clearing the last input if not the only one
            } else if (newName === '' && currentObjects.length === 1) {
                 // Allow clearing the only input
            } else if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(newName)) {
                 alert("åˆ—è¡¨å¯¹è±¡åç§°å¿…é¡»ä»¥å­—æ¯æˆ–ä¸‹åˆ’çº¿å¼€å¤´ï¼Œä¸”åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ã€‚");
                 renderListFieldArea(); // Re-render to reset
                 return;
            } else if (currentObjects.some((name, i) => name === newName && i !== index)) {
                  alert(`åˆ—è¡¨ "${listName}" ä¸­å·²å­˜åœ¨å¯¹è±¡åç§° "${newName}"ã€‚`);
                  renderListFieldArea(); // Re-render to reset
                  return;
            }

            // Update the model
            currentObjects[index] = newName;

            // Update data keys if name changed and was valid before
            if (oldName && oldName !== newName && listData[listName]) {
                listData[listName].forEach(row => {
                     if(row.hasOwnProperty(oldName)) {
                         // Only add new key if newName is valid
                         if (newName) {
                            row[newName] = row[oldName];
                         }
                         delete row[oldName];
                     }
                 });
            }

            console.log(`Updated list object name for ${listName}[${index}] to "${newName}"`);
            renderListFillingTables(); // Re-render filling table headers/structure
            updatePreview();
        }


        // --- List Manipulation ---
        function addListObjectRow(buttonElement) {
             const row = buttonElement.closest('.list-object-row');
             const container = buttonElement.closest('.list-definition-block');
             const listName = container.dataset.listName;
             const currentObjects = listFields[listName];
             const currentIndex = parseInt(row.dataset.index, 10);

             // Validate current row before adding new
             const currentInput = row.querySelector('input[type="text"]');
             const currentName = currentInput.value.trim();
             if (!currentName) {
                 alert('è¯·å…ˆä¸ºå½“å‰è¡Œè¾“å…¥åˆ—è¡¨å¯¹è±¡åç§°ã€‚'); return;
             }
             if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(currentName)) {
                 alert("åˆ—è¡¨å¯¹è±¡åç§°å¿…é¡»ä»¥å­—æ¯æˆ–ä¸‹åˆ’çº¿å¼€å¤´ï¼Œä¸”åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ã€‚"); return;
             }
             if (currentObjects.some((name, i) => name === currentName && i !== currentIndex)) {
                  alert(`åˆ—è¡¨ "${listName}" ä¸­å·²å­˜åœ¨å¯¹è±¡åç§° "${currentName}"ã€‚`); return;
             }
             // Ensure model is updated if changed just before clicking add
             if (currentObjects[currentIndex] !== currentName) {
                  updateListObjectName(listName, currentIndex, currentName);
                  // Re-check objects after potential update
                  if (currentObjects.some((name, i) => name === currentName && i !== currentIndex)) return; // Abort if still duplicate
             }


             // Add new row visually
             const newIndex = currentObjects.length;
             const newRowHTML = createListObjectRowHTML(listName, '', newIndex, false);
             row.insertAdjacentHTML('afterend', newRowHTML);

             // Add empty placeholder to the model for the new row
             currentObjects.push('');

             console.log(`Added new object row for list ${listName} at index ${newIndex}`);
             // No need to re-render filling table yet, only when object name is confirmed
        }

        function removeListObjectRow(buttonElement, listName, index) {
             const container = buttonElement.closest('.list-definition-block');
             const row = buttonElement.closest('.list-object-row');
             const currentObjects = listFields[listName];
             const objectNameToRemove = currentObjects[index];

             if (container.querySelectorAll('.list-object-row').length <= 1) {
                 // Clear the only row
                 const input = row.querySelector('input[type="text"]');
                 input.value = '';
                 currentObjects[index] = '';
                 console.log(`Cleared last object row for list ${listName}`);
             } else {
                 row.remove();
                 currentObjects.splice(index, 1); // Remove from model
                 console.log(`Removed object row ${index} for list ${listName}`);
                 // Re-index subsequent rows in the DOM (important for correct indices)
                 container.querySelectorAll('.list-object-row').forEach((r, i) => {
                     r.dataset.index = i;
                     const input = r.querySelector('input');
                     input.onchange = () => updateListObjectName(listName, i, input.value);
                     const delBtn = r.querySelector('.delete-list-object-btn');
                     delBtn.onclick = () => removeListObjectRow(delBtn, listName, i);
                     // Update first-row class for name label visibility
                      if (i === 0) r.classList.add('is-first-row');
                      else r.classList.remove('is-first-row');
                 });
             }

             // Clean up data: remove column associated with the removed object name
             if (objectNameToRemove && listData[listName]) {
                 listData[listName].forEach(rowData => {
                     delete rowData[objectNameToRemove];
                 });
             }

             renderListFillingTables(); // Re-render filling table due to structure change
             updatePreview();
        }

        function addListDataRow(listName) {
             const tableContainer = listFillingContainer.querySelector(`.list-data-table-block[data-list-name="${listName}"]`);
             const tableBody = tableContainer?.querySelector('tbody');
             if (!tableBody) return;

             const listObjects = listFields[listName].filter(name => name.trim() !== '');
             if (listObjects.length === 0) {
                  alert(`åˆ—è¡¨ "${listName}" æ²¡æœ‰å®šä¹‰æœ‰æ•ˆçš„å¯¹è±¡åç§°ï¼Œæ— æ³•æ·»åŠ æ•°æ®è¡Œã€‚`);
                  return;
             }

             const newRowIndex = tableBody.rows.length;

             // Validation: Check last row emptiness
             if (newRowIndex > 0) {
                 const lastRow = tableBody.rows[newRowIndex - 1];
                 let lastRowIsEmpty = true;
                 lastRow.querySelectorAll('input[type="text"]').forEach(input => {
                     if (input.value.trim() !== '') lastRowIsEmpty = false;
                 });
                 if (lastRowIsEmpty) {
                      alert("è¯·å…ˆå¡«å†™ä¸Šä¸€è¡Œçš„æ•°æ®ï¼Œå†æ·»åŠ æ–°è¡Œã€‚"); return;
                 }
             }

             // Add new row to data model first
             if (!listData[listName]) listData[listName] = [];
             listData[listName].push({}); // Add empty object for the new row

             // Add new row visually
             const newRowHTML = createListDataRowHTML(listName, listObjects, newRowIndex);
             tableBody.insertAdjacentHTML('beforeend', newRowHTML);

             console.log(`Added data row ${newRowIndex} to list ${listName}`);
             updatePreview(); // Update preview as data changed
        }


        // --- Editor & Preview ---

         function insertPlaceholder(fieldName, isObjectField = true) {
             let placeholderText = '';
             if (isObjectField) {
                 const field = objectFields.find(f => f.name === fieldName);
                 if (field) placeholderText = field.placeholder;
             }
             // Placeholder insertion logic remains largely the same as before...
              if (!placeholderText) {
                   console.warn("Cannot find placeholder for:", fieldName); return;
              }

              insertTextIntoEditor(placeholderText, true); // Use helper function
         }

        function insertListObjectPlaceholder(listName, objectName) {
            const placeholderText = `{{${listName}.${objectName}}}`; // Standard list object format
            insertTextIntoEditor(placeholderText, true);
        }

        function insertTextIntoEditor(text, isPlaceholder = false) {
             const editor = templateEditorContent;
             editor.focus(); // Ensure editor has focus

             const selection = window.getSelection();
             if (!selection.rangeCount) return;
             const range = selection.getRangeAt(0);

             if (!editor.contains(range.commonAncestorContainer) && !(editor === range.commonAncestorContainer)) {
                 console.log("Cursor not inside editor."); return;
             }

             range.deleteContents(); // Remove selection

             let nodeToInsert;
             if (isPlaceholder) {
                 const placeholderNode = document.createElement('span');
                 placeholderNode.className = 'editor-placeholder';
                 placeholderNode.textContent = text;
                 placeholderNode.contentEditable = 'false';
                 // Add zero-width spaces around for better cursor behavior (optional)
                 // nodeToInsert = document.createDocumentFragment();
                 // nodeToInsert.appendChild(document.createTextNode('\u200B'));
                 // nodeToInsert.appendChild(placeholderNode);
                 // nodeToInsert.appendChild(document.createTextNode('\u200B'));
                 nodeToInsert = placeholderNode;
             } else {
                 nodeToInsert = document.createTextNode(text);
             }

             range.insertNode(nodeToInsert);

             // Move cursor after the inserted node
             range.setStartAfter(nodeToInsert);
             range.collapse(true);
             selection.removeAllRanges();
             selection.addRange(range);

             console.log("Inserted:", text);
             handleEditorInput(); // Trigger preview update
        }


        function handleEditorInput() {
            currentTemplateContent = templateEditorContent.innerHTML;
            updatePreview();
        }

        function updatePreview() {
            // --- Preview logic needs significant work for lists/loops ---
             if (currentTemplateType === 'excel') { /* Handle Excel Preview */ return; }

             console.log("Updating preview...");
             let previewHTML = currentTemplateContent;

             // 1. Replace object fields {{fieldName}}
             objectFields.forEach(field => {
                 const value = escapeHtml(objectData[field.name] || ''); // Escape data
                 const placeholderRegex = new RegExp(escapeRegExp(field.placeholder), 'g');
                 previewHTML = previewHTML.replace(placeholderRegex, value);
             });

             // 2. --- VERY BASIC List Placeholder Handling ---
             // This requires a proper templating engine (like Handlebars, Mustache, or a custom parser)
             // to handle loops {#listName}...{/listName} and {{objectName}} inside.
             // This SIMULATION will just show a placeholder.
             for (const listName in listFields) {
                 const loopStartRegex = new RegExp(escapeRegExp(`{#${listName}}`), 'g');
                 const loopEndRegex = new RegExp(escapeRegExp(`{/${listName}}`), 'g');

                 // Find content between loop tags (if they exist)
                 let loopContentMatch = previewHTML.match(new RegExp(escapeRegExp(`{#${listName}}`) + '(.*?)' + escapeRegExp(`{/${listName}}`), 's')); // 's' for dotall

                 if (loopContentMatch) {
                     let originalLoopBlock = loopContentMatch[0];
                     let loopTemplate = loopContentMatch[1];
                     let renderedLoop = '';
                     const currentListData = listData[listName] || [];
                     const listObjects = listFields[listName].filter(name => name.trim() !== '');

                     currentListData.forEach(rowData => {
                         let rowHTML = loopTemplate;
                         listObjects.forEach(objName => {
                              const value = escapeHtml(rowData[objName] || '');
                              // Replace {{objName}} or {{this.objName}} etc. inside the loop template
                              const objPlaceholderRegex = new RegExp(escapeRegExp(`{{${objName}}}`), 'g');
                              // Add variations like {{this.objName}} if needed
                              rowHTML = rowHTML.replace(objPlaceholderRegex, value);
                         });
                         renderedLoop += rowHTML;
                     });
                     // Replace the entire loop block with the rendered content
                     previewHTML = previewHTML.replace(originalLoopBlock, renderedLoop);

                 } else {
                     // Fallback: Simple replacement for {{listName.objectName}} if no loop tags used (less common)
                     const listObjects = listFields[listName].filter(name => name.trim() !== '');
                     listObjects.forEach(objName => {
                          const placeholder = `{{${listName}.${objName}}}`;
                          const placeholderRegex = new RegExp(escapeRegExp(placeholder), 'g');
                          previewHTML = previewHTML.replace(placeholderRegex, `[${listName}.${objName} data - use loop tags {#${listName}}...{/${listName}} in template]`);
                     });
                 }
             }

             // Remove editor-specific spans
             previewHTML = previewHTML.replace(/<span class="editor-placeholder"[^>]*>(.*?)<\/span>/g, '$1');
              // Replace zero-width spaces if added during insertion
             // previewHTML = previewHTML.replace(/\u200B/g, '');

             previewContent.innerHTML = previewHTML;
        }

        function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe; // Handle non-strings
            return unsafe
                 .replace(/&/g, "&")
                 .replace(/</g, "<")
                 .replace(/>/g, ">")
                 .replace(/"/g, """)
                 .replace(/'/g, "'");
        }

        // --- Bottom Button Actions ---

        function saveTemplate() {
             if (!loadedTemplatePath) { alert("è¯·å…ˆä½¿ç”¨â€œé€‰æ‹©æ¨¡æ¿â€åŠ è½½ä¸€ä¸ªæ¨¡æ¿æ–‡ä»¶ï¼Œæ‰èƒ½è¦†ç›–ä¿å­˜ã€‚"); return; }
             const contentToSave = templateEditorContent.innerHTML; // For Word; Need Excel data structure for Excel
             console.log("Saving template (overwrite):", loadedTemplatePath.name);
             alert(`æ¨¡æ‹Ÿè¦†ç›–ä¿å­˜æ¨¡æ¿ "${loadedTemplatePath.name}"ã€‚\nå®é™…æ“ä½œéœ€è¦ File System Access API æˆ–æœåŠ¡å™¨æ”¯æŒã€‚`);
             // --- Needs File System Access API or Server ---
        }

        function generateNewTemplate() {
            const contentToSave = templateEditorContent.innerHTML; // For Word; Need Excel data structure for Excel
            const timestamp = new SimpleDateFormat("yyyyMMdd_HHmmss").format(new Date());
            const typeName = currentTemplateType === 'word' ? 'Word' : 'Excel';
            const extension = currentTemplateType === 'word' ? 'docx' : 'xlsx';
            const defaultFileName = `æ¨¡æ¿_${typeName}_${timestamp}.${extension}`;
            console.log("Generating new template:", defaultFileName);
            alert(`æ¨¡æ‹Ÿç”Ÿæˆæ–°æ¨¡æ¿ "${defaultFileName}"ã€‚\næ³¨æ„ï¼šå®é™…ç”Ÿæˆ DOCX/XLSX éœ€è¦ä¸“é—¨åº“ã€‚`);
             // --- Needs library to generate DOCX/XLSX and trigger download ---
             // --- DEMO: Download raw HTML ---
             // downloadBlob(contentToSave, defaultFileName.replace(extension, 'html'), 'text/html');
        }

        function generateDocument() {
            // Use the *processed* preview content for generation
            const renderedContent = previewContent.innerHTML; // For Word; Need different logic for Excel
            const templateNameBase = loadedTemplatePath ? loadedTemplatePath.name.split('.').slice(0, -1).join('.') : 'æœªå‘½åæ¨¡æ¿';
            const timestamp = new SimpleDateFormat("yyyyMMdd_HHmmss").format(new Date());
            const typeName = currentTemplateType === 'word' ? 'Word' : 'Excel';
            const extension = currentTemplateType === 'word' ? 'docx' : 'xlsx'; // Or PDF?
            const defaultFileName = `${templateNameBase}_æ–‡æ¡£_${timestamp}.${extension}`;
            console.log("Generating document:", defaultFileName);
             alert(`æ¨¡æ‹Ÿç”Ÿæˆæ–‡æ¡£ "${defaultFileName}"ã€‚\næ³¨æ„ï¼šå®é™…ç”Ÿæˆ DOCX/XLSX/PDF éœ€è¦ä¸“é—¨åº“ã€‚`);
            // --- Needs library to generate DOCX/XLSX/PDF from processed data/template ---
            // --- DEMO: Download preview HTML ---
            // downloadBlob(`<html><head><meta charset="UTF-8"><title>æ–‡æ¡£é¢„è§ˆ</title></head><body>${renderedContent}</body></html>`, defaultFileName.replace(extension, 'html'), 'text/html');
        }

        // Helper for demo download
        function downloadBlob(content, filename, contentType) {
             try {
                 const blob = new Blob([content], { type: contentType });
                 const link = document.createElement('a');
                 link.href = URL.createObjectURL(blob);
                 link.download = filename;
                 link.click();
                 URL.revokeObjectURL(link.href);
             } catch (e) {
                 console.error("Error triggering download:", e);
                 alert("ä¸‹è½½æ–‡ä»¶æ—¶å‡ºé”™ã€‚");
             }
        }

        // Simple Date Formatting
        class SimpleDateFormat { /* ... Same as previous ... */
            constructor(format) { this.formatStr = format; }
            format(date) {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const seconds = date.getSeconds().toString().padStart(2, '0');
                return this.formatStr
                    .replace('yyyy', year).replace('MM', month).replace('dd', day)
                    .replace('HH', hours).replace('mm', minutes).replace('ss', seconds);
            }
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Document Generator UI Initialized (Aesthetic Version).");
            renderObjectFieldList();
            renderListFieldArea();
            renderObjectFillingList();
            renderListFillingTables();
            handleTemplateTypeChange(); // Set initial editor visibility
        });

    </script>
</body>
</html>